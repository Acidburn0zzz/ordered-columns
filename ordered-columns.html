<!--
@homepage https://github.com/stevenrskelton/ordered-columns
@element ordered-columns
@demo http://files.stevenskelton.ca/ordered-columns/examples/
-->

<link rel="import" href="../polymer/polymer.html">

<polymer-element name="ordered-columns" attributes="count redraw">
	<template>
		<style>
			:host {
				display: inline-block;
			}
			.column {
				box-sizing: border-box;
				display: inline-block;
				vertical-align: top;
			}
		</style>
		<table style="width:100%" cellpadding="0" cellspacing="0">
			<tr>
				<template repeat="{{width,i in columnWidths}}"><td
					id="column{{i}}"
					class="column"
					style="width: {{width}};"
				></td></template>
			</tr>
		</table>
		<div style="width:{{standardWidth}};display:none">
			<content id="hiddenDiv" select='article,[role="article"]'></content>
		</div>
	</template>
	<script>
	"use strict";
	Polymer({
		redraw: false,
		ready: function(){
			var self = this;
			this.setColumnWidths();
			this.load();
			window.addEventListener('resize', function(e) {
				if(self.redraw) self.refresh.call(self);
				else self.setStandardWidth.call(self);
			});
			this.onMutation(this, this.append);
		},
		count: 1,
		observe: {
			count: 'refresh'
		},
		append: function(observer, mutations){
			var self = this;
			mutations.forEach(function(m) {
				if(m.type === 'childList'){
					var newArticles = [].filter.call(m.addedNodes, function(element){
						return element.nodeName === 'ARTICLE' || (element.getAttribute && element.getAttribute('role') === 'article');
					});
					newArticles.forEach(function(element){
						self.items.push(element);
					});
					self.async(function() {
						self.moveItems(newArticles);
					});
				}
			});
			this.onMutation(this, this.append);
		},
		refresh: function(){
			var self = this;
			this.setColumnWidths();
			this.async(function() {
				var hiddenDiv = self.$.hiddenDiv;
				self.items.forEach(function(element,i){
					hiddenDiv.appendChild(element);
				});
				self.moveItems(self.items);
			});
		},
		load: function(){
			var items = [];
			[].forEach.call(this.$.hiddenDiv.getDistributedNodes(), function(o){ items.push(o)});
			this.items = items;
			var self = this;
			this.async(function() {
				self.moveItems(items);
			});
		},
		moveItems: function(items){
			var columns = this.shadowRoot.querySelectorAll('.column');
			items.forEach(function(element,i){
				var column = columns[0];
				[].forEach.call(columns, function(c){
					if(c.clientHeight < column.clientHeight) column = c;
				});
				column.appendChild(element);
			});
		},
		setColumnWidths: function(){
			var arr = [];
			var count = Math.max(this.count,1);
			var min = Math.floor(100 / count);
			for(var i=0;i<count-1;i++) arr.push(min + '%');
			arr.push((100 - min * (count-1)) + '%');
			this.columnWidths = arr;
			this.setStandardWidth();
		},
		setStandardWidth: function(){
			var columns = this.shadowRoot.querySelectorAll('.column');
			if(columns.length > 0) this.standardWidth = columns[0].clientWidth + 'px';
			else if(this.clientWidth) this.standardWidth = (this.clientWidth / Math.max(this.count,1)) + 'px';
			else this.standardWidth = (100 / Math.max(this.count,1)) + '%';
		},
		columnWidths: null,
		standardWidth: null,
		items: null
	});
	</script>
</polymer-element>